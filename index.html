<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=800, height=480, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>TRMNL Wetter Bönen</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="preconnect" href="https://fonts.cdnfonts.com" crossorigin>
  <link href="https://fonts.cdnfonts.com/css/share-tech-mono" rel="stylesheet">
  <link href="https://fonts.cdnfonts.com/css/charles-wright" rel="stylesheet">
  <style>
    @import url('https://fonts.cdnfonts.com/css/charles-wright');
  </style>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    html { 
      width: 800px;
      height: 480px;
      overflow: hidden;
    }
    
    html, body { 
      width: 800px;
      height: 480px; 
      overflow: hidden;
      margin: 0;
      padding: 0;
      position: fixed;
      top: 0;
      left: 0;
    }
    
    body {
      background: #fff;
      color: #000;
      font-family: 'Share Tech Mono', 'Courier New', monospace;
      font-weight: 400;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body.invert { 
      background: #000; 
      color: #fff; 
    }

    .canvas {
      width: 800px;
      height: 480px;
      display: grid;
      grid-template-columns: 280px 520px;
      gap: 0;
      padding: 0;
      margin: 0;
      position: relative;
    }

    /* ===== LINKE SEITE: WETTER ===== */
    .weather {
      background: #fff;
      color: #000;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      height: 480px;
      width: 280px;
      border-right: 2px solid #000;
      font-family: 'Charles Wright', sans-serif;
    }
    
    .weather * {
      font-family: 'Charles Wright', sans-serif;
    }
    
    body.invert .weather {
      background: #000;
      color: #fff;
      border-right: 2px solid #fff;
    }

    .location {
      display: none;
    }

    .weather-condition {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 32px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .temp-hi {
      font-size: 42px;
      font-weight: 600;
      margin-bottom: 32px;
    }
    
    .temp-hi::before { 
      content: '△ '; 
      font-size: 34px;
    }

    .temp-main {
      font-size: 108px;
      font-weight: 700;
      line-height: 0.9;
      letter-spacing: -2px;
      margin: 40px 0;
    }

    .temp-lo {
      font-size: 42px;
      font-weight: 600;
      margin-top: 32px;
    }
    
    .temp-lo::before { 
      content: '▽ '; 
      font-size: 34px;
    }

    .temp-range {
      display: none;
    }

    .rain-prob {
      display: none;
    }

    /* ===== RECHTE SEITE: LISTE ===== */
    .content {
      background: #fff;
      color: #000;
      padding: 32px 36px;
      display: flex;
      flex-direction: column;
      height: 480px;
      width: 520px;
      overflow: hidden;
    }
    
    body.invert .content {
      background: #000;
      color: #fff;
    }

    .list-header {
      display: none;
    }

    .sheet-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 2px;
      max-height: 100%;
      overflow: hidden;
    }

    .sheet-item {
      font-size: 32px;
      font-weight: 700;
      padding: 14px 0;
      border-bottom: 1px solid currentColor;
      letter-spacing: -0.3px;
    }

    .sheet-item:nth-child(n+7) {
      display: none;
    }

    .sheet-item:last-child {
      border-bottom: none;
    }

    /* Aktualisierungszeit */
  </style>
</head>
<body>
  <div class="canvas">
    <!-- LINKE SEITE: WETTER -->
    <div class="weather">
      <div class="location">BÖNEN</div>
      <div class="temp-hi" id="hi">–°</div>
      <div class="temp-main" id="temp">–°</div>
      <div class="weather-condition" id="weather-condition">Lädt...</div>
      <div class="temp-lo" id="lo">–°</div>
    </div>

    <!-- RECHTE SEITE: LISTE -->
    <div class="content">
      <div class="list-header">Aufgaben</div>
      <ul class="sheet-list" id="sheet-list">
        <li class="sheet-item">Lädt …</li>
      </ul>
    </div>
  </div>

  <script>
    (function() {
      const lat = 51.600;
      const lon = 7.766;

      // Invert-Modus
      const params = new URLSearchParams(location.search);
      if (params.get('invert') === '1' || params.get('invert') === 'true') {
        document.body.classList.add('invert');
      }

      // ===== WETTER LADEN =====
      async function loadWeather() {
        try {
          const url = new URL('https://api.open-meteo.com/v1/forecast');
          url.searchParams.set('latitude', lat);
          url.searchParams.set('longitude', lon);
          url.searchParams.set('timezone', 'auto');
          url.searchParams.set('current_weather', 'true');
          url.searchParams.set('daily', 'temperature_2m_max,temperature_2m_min,weathercode');

          const res = await fetch(url.toString(), { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();

          const cw = data.current_weather || {};
          const daily = data.daily || {};
          const todayIdx = 0;

          const nowTemp = cw.temperature != null ? Math.round(cw.temperature) : null;
          const tMax = daily.temperature_2m_max ? Math.round(daily.temperature_2m_max[todayIdx]) : null;
          const tMin = daily.temperature_2m_min ? Math.round(daily.temperature_2m_min[todayIdx]) : null;
          const weatherCode = cw.weathercode != null ? cw.weathercode : null;

          if (nowTemp != null) document.getElementById('temp').textContent = nowTemp + '°';
          if (tMax != null) document.getElementById('hi').textContent = tMax + '°';
          if (tMin != null) document.getElementById('lo').textContent = tMin + '°';
          if (weatherCode != null) {
            document.getElementById('weather-condition').textContent = getWeatherText(weatherCode);
          }
        } catch (err) {
          console.error('Wetter-Fehler:', err);
        }
      }

      // Wetter-Text basierend auf WMO Weather codes
      function getWeatherText(code) {
        if (code === 0) return 'Klar';
        if (code === 1) return 'Heiter';
        if (code === 2) return 'Teilweise bewölkt';
        if (code === 3) return 'Bewölkt';
        if (code >= 45 && code <= 48) return 'Neblig';
        if (code >= 51 && code <= 55) return 'Nieselregen';
        if (code >= 56 && code <= 57) return 'Gefrierender Nieselregen';
        if (code >= 61 && code <= 65) return 'Regen';
        if (code >= 66 && code <= 67) return 'Gefrierender Regen';
        if (code >= 71 && code <= 75) return 'Schneefall';
        if (code >= 77) return 'Schneegriesel';
        if (code >= 80 && code <= 82) return 'Regenschauer';
        if (code >= 85 && code <= 86) return 'Schneeschauer';
        if (code >= 95 && code <= 99) return 'Gewitter';
        return 'Unbekannt';
      }

      // ===== GOOGLE SHEET LADEN =====
      async function loadSheet() {
        const id = '1SfImqWa8PeKYWaXs01YQdFRSyUABkPlhBNluPeB6q8c';
        const endpoints = [
          `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&range=A2:A`,
          `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&range=A2:A50`
        ];
        const list = document.getElementById('sheet-list');
        list.innerHTML = '<li class="sheet-item">Lädt …</li>';
        
        for (const url of endpoints) {
          try {
            const res = await fetch(url, { cache: 'no-store', mode: 'cors' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const text = await res.text();
            const rows = text.split(/\r?\n/)
              .map(s => s.replace(/^"|"$/g, '').trim())
              .filter(Boolean);
            
            if (rows.length) {
              list.innerHTML = rows
                .map(v => `<li class="sheet-item">${escapeHTML(v)}</li>`)
                .join('');
              return;
            }
          } catch (e) {
            console.error('Sheet-Fehler:', e);
          }
        }
        list.innerHTML = '<li class="sheet-item">Keine Daten verfügbar</li>';
      }

      function escapeHTML(s) {
        return s.replace(/[&<>"]/g, c => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;'
        }[c]));
      }

      // Initialisierung
      loadWeather();
      loadSheet();
      setInterval(loadWeather, 15 * 60 * 1000);  // Alle 15 Minuten
      setInterval(loadSheet, 5 * 60 * 1000);     // Alle 5 Minuten
    })();
  </script>
</body>
</html>
