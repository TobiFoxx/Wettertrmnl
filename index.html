<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=800, height=480" />
  <title>TRMNL Wetter Bönen</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="preconnect" href="https://fonts.cdnfonts.com" crossorigin>
  <link href="https://fonts.cdnfonts.com/css/charles-wright" rel="stylesheet">
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    html, body { 
      height: 100%; 
      overflow: hidden;
    }
    
    body {
      background: #fff;
      color: #000;
      font-family: 'Charles Wright', -apple-system, system-ui, sans-serif;
      font-weight: 400;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body.invert { 
      background: #000; 
      color: #fff; 
    }

    .canvas {
      width: 800px;
      height: 480px;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 0;
      padding: 0;
    }

    /* ===== LINKE SEITE: WETTER ===== */
    .weather {
      background: #000;
      color: #fff;
      padding: 32px 28px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    body.invert .weather {
      background: #fff;
      color: #000;
    }

    .location {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 1.5px;
      margin-bottom: 24px;
    }

    .temp-main {
      font-size: 108px;
      font-weight: 700;
      line-height: 0.9;
      letter-spacing: -2px;
      margin: 20px 0;
    }

    .temp-range {
      display: flex;
      gap: 24px;
      font-size: 32px;
      font-weight: 500;
      margin: 16px 0;
      opacity: 0.85;
    }

    .temp-hi::before { content: '△ '; opacity: 0.6; }
    .temp-lo::before { content: '▽ '; opacity: 0.6; }

    .rain-prob {
      font-size: 18px;
      font-weight: 400;
      margin-top: 20px;
      opacity: 0.75;
      line-height: 1.4;
    }

    /* ===== RECHTE SEITE: LISTE ===== */
    .content {
      background: #fff;
      color: #000;
      padding: 32px 36px;
      display: flex;
      flex-direction: column;
    }
    
    body.invert .content {
      background: #000;
      color: #fff;
    }

    .list-header {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid currentColor;
      opacity: 0.7;
    }

    .sheet-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sheet-item {
      font-size: 24px;
      font-weight: 500;
      padding: 10px 0;
      border-bottom: 1px solid currentColor;
      opacity: 0.9;
    }

    .sheet-item:last-child {
      border-bottom: none;
    }

    /* Aktualisierungszeit */
    .update-time {
      position: absolute;
      bottom: 8px;
      right: 12px;
      font-size: 11px;
      opacity: 0.4;
      font-weight: 400;
    }
  </style>
</head>
<body>
  <div class="canvas">
    <!-- LINKE SEITE: WETTER -->
    <div class="weather">
      <div>
        <div class="location">BÖNEN</div>
        <div class="temp-main" id="temp">–°</div>
        <div class="temp-range">
          <span class="temp-hi" id="hi">–°</span>
          <span class="temp-lo" id="lo">–°</span>
        </div>
      </div>
      <div class="rain-prob" id="prob">Regen: – %</div>
    </div>

    <!-- RECHTE SEITE: LISTE -->
    <div class="content">
      <div class="list-header">Aufgaben</div>
      <ul class="sheet-list" id="sheet-list">
        <li class="sheet-item">Lädt …</li>
      </ul>
    </div>
  </div>

  <div class="update-time" id="update-time"></div>

  <script>
    (function() {
      const lat = 51.600;
      const lon = 7.766;

      // Invert-Modus
      const params = new URLSearchParams(location.search);
      if (params.get('invert') === '1' || params.get('invert') === 'true') {
        document.body.classList.add('invert');
      }

      // Aktualisierungszeit
      function updateTime() {
        const now = new Date();
        const time = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('update-time').textContent = `${time}`;
      }

      // ===== WETTER LADEN =====
      async function loadWeather() {
        try {
          const url = new URL('https://api.open-meteo.com/v1/forecast');
          url.searchParams.set('latitude', lat);
          url.searchParams.set('longitude', lon);
          url.searchParams.set('timezone', 'auto');
          url.searchParams.set('current_weather', 'true');
          url.searchParams.set('daily', 'temperature_2m_max,temperature_2m_min,precipitation_probability_max');
          url.searchParams.set('hourly', 'precipitation_probability');

          const res = await fetch(url.toString(), { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();

          const cw = data.current_weather || {};
          const daily = data.daily || {};
          const todayIdx = 0;

          const nowTemp = cw.temperature != null ? Math.round(cw.temperature) : null;
          const tMax = daily.temperature_2m_max ? Math.round(daily.temperature_2m_max[todayIdx]) : null;
          const tMin = daily.temperature_2m_min ? Math.round(daily.temperature_2m_min[todayIdx]) : null;

          let prob = null;
          if (daily.precipitation_probability_max && daily.precipitation_probability_max[todayIdx] != null) {
            prob = Math.round(daily.precipitation_probability_max[todayIdx]);
          } else if (data.hourly && data.hourly.time && data.hourly.precipitation_probability) {
            const tzNow = new Date();
            const start = new Date(tzNow.getFullYear(), tzNow.getMonth(), tzNow.getDate(), 0, 0, 0);
            const end = new Date(tzNow.getFullYear(), tzNow.getMonth(), tzNow.getDate(), 23, 59, 59);
            let maxP = null;
            for (let i = 0; i < data.hourly.time.length; i++) {
              const t = new Date(data.hourly.time[i]);
              if (t >= start && t <= end) {
                const p = data.hourly.precipitation_probability[i];
                if (p != null) maxP = maxP == null ? p : Math.max(maxP, p);
              }
            }
            if (maxP != null) prob = Math.round(maxP);
          }

          if (nowTemp != null) document.getElementById('temp').textContent = nowTemp + '°';
          if (tMax != null) document.getElementById('hi').textContent = tMax + '°';
          if (tMin != null) document.getElementById('lo').textContent = tMin + '°';
          if (prob != null) document.getElementById('prob').textContent = 'Regen: ' + prob + ' %';
          
          updateTime();
        } catch (err) {
          console.error('Wetter-Fehler:', err);
        }
      }

      // ===== GOOGLE SHEET LADEN =====
      async function loadSheet() {
        const id = '1SfImqWa8PeKYWaXs01YQdFRSyUABkPlhBNluPeB6q8c';
        const endpoints = [
          `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&range=A2:A`,
          `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&range=A2:A50`
        ];
        const list = document.getElementById('sheet-list');
        list.innerHTML = '<li class="sheet-item">Lädt …</li>';
        
        for (const url of endpoints) {
          try {
            const res = await fetch(url, { cache: 'no-store', mode: 'cors' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const text = await res.text();
            const rows = text.split(/\r?\n/)
              .map(s => s.replace(/^"|"$/g, '').trim())
              .filter(Boolean);
            
            if (rows.length) {
              list.innerHTML = rows
                .map(v => `<li class="sheet-item">${escapeHTML(v)}</li>`)
                .join('');
              return;
            }
          } catch (e) {
            console.error('Sheet-Fehler:', e);
          }
        }
        list.innerHTML = '<li class="sheet-item">Keine Daten verfügbar</li>';
      }

      function escapeHTML(s) {
        return s.replace(/[&<>"]/g, c => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;'
        }[c]));
      }

      // Initialisierung
      loadWeather();
      loadSheet();
      setInterval(loadWeather, 15 * 60 * 1000);  // Alle 15 Minuten
      setInterval(loadSheet, 5 * 60 * 1000);     // Alle 5 Minuten
      setInterval(updateTime, 60 * 1000);        // Jede Minute
    })();
  </script>
</body>
</html>
